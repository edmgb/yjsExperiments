<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yjs test</title>
</head>

<body>
    <script type=module>
        import * as Y from 'yjs'
        import { WebsocketProvider } from 'y-websocket'
        import { IndexeddbPersistence } from 'y-indexeddb'

        const ydoc = new Y.Doc()
        const websocketProvider = new WebsocketProvider('wss://demos.yjs.dev', 'x-mpo', ydoc)

        const yarray = ydoc.getMap('count')

        const div = document.createElement('div')
        document.body.appendChild(div)
        const indexeddbProvider = new IndexeddbPersistence('x-mpo', ydoc)
            indexeddbProvider.whenSynced.then(() => {
            console.log('loaded data from indexed db')
            div.innerText = `loaded data from indexed db\n`
            ydoc.get('count').forEach(d => {
                console.log("sync map:",d)
                div.innerText += `${d}\n`
            })
        })

        yarray.observe(event => {
            console.log('observe map:', ydoc.get('count'));
            console.log('changed keys:', event.changes.keys)
            ydoc.get('count').forEach(d => {
                div.innerText += `${d}\n`
            })
        })

        const button = document.createElement('button')
        document.body.appendChild(button)
        button.textContent = 'send msg'
        button.addEventListener('click', event => {
            yarray.set('count', new Date().toISOString());
        }) 
    </script>
</body>

</html>